<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Production HUD - Wheel Tracker v2</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Babel (JSX Converter) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        .glow-text {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Loading Overlay */
        #loading {
            position: fixed;
            inset: 0;
            background: #020617;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-50 overflow-hidden">

    <div id="loading">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-4"></div>
        <div class="text-sm font-mono text-slate-400">LOADING SYSTEM...</div>
    </div>

    <div id="root"></div>

    <!-- MAIN SCRIPT -->
    <script type="text/babel" data-type="module">
        // Import libraries directly from ESM.SH (Reliable CDN)
        import React, { useState, useEffect, useCallback, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import * as LucideIcons from 'https://esm.sh/lucide-react@0.263.1';

        // Hide Loading Screen once scripts run
        setTimeout(() => {
            const loader = document.getElementById('loading');
            if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
        }, 500);

        const {
            Settings, FileText, Download, LayoutDashboard,
            Clock, PenTool, Activity, Pencil, X, Search,
            FileDown, Upload, RotateCcw, Save, Settings2, HelpCircle, MessageSquare
        } = LucideIcons;

        /* ================= CONSTANTS ================= */
        const LINES = ['A', 'B', 'C', 'D', 'E'];

        const LINE_COLORS = {
            A: '#3b82f6', B: '#10b981', C: '#f59e0b', D: '#8b5cf6', E: '#ef4444',
        };

        const DEFAULT_CONFIG = {
            lines: {
                A: { name: 'LINE A', categories: ["ÊÆµÂèñ„Çä", "Á®ºÂÉç", "ÂÅúÊ≠¢", "ÂæÖÊ©ü", { name: "„Éà„É©„Éñ„É´", subCategories: ["Ë®≠ÂÇôÊïÖÈöú", "ÊùêÊñô‰∏çËâØ", "ÂìÅË≥™Áï∞Â∏∏", "„Åù„ÅÆ‰ªñ"] }, "‰ºëÊÜ©"] },
                B: { name: 'LINE B', categories: ["ÊÆµÂèñ„Çä", "Á®ºÂÉç", "ÂÅúÊ≠¢", "ÂæÖÊ©ü", { name: "„Éà„É©„Éñ„É´", subCategories: ["Ë®≠ÂÇôÊïÖÈöú", "ÊùêÊñô‰∏çËâØ", "ÂìÅË≥™Áï∞Â∏∏", "„Åù„ÅÆ‰ªñ"] }, "‰ºëÊÜ©"] },
                C: { name: 'LINE C', categories: ["ÊÆµÂèñ„Çä", "Á®ºÂÉç", "ÂÅúÊ≠¢", "ÂæÖÊ©ü", { name: "„Éà„É©„Éñ„É´", subCategories: ["Ë®≠ÂÇôÊïÖÈöú", "ÊùêÊñô‰∏çËâØ", "ÂìÅË≥™Áï∞Â∏∏", "„Åù„ÅÆ‰ªñ"] }, "‰ºëÊÜ©"] },
                D: { name: 'LINE D', categories: ["ÊÆµÂèñ„Çä", "Á®ºÂÉç", "ÂÅúÊ≠¢", "ÂæÖÊ©ü", { name: "„Éà„É©„Éñ„É´", subCategories: ["Ë®≠ÂÇôÊïÖÈöú", "ÊùêÊñô‰∏çËâØ", "ÂìÅË≥™Áï∞Â∏∏", "„Åù„ÅÆ‰ªñ"] }, "‰ºëÊÜ©"] },
                E: { name: 'LINE E', categories: ["ÊÆµÂèñ„Çä", "Á®ºÂÉç", "ÂÅúÊ≠¢", "ÂæÖÊ©ü", { name: "„Éà„É©„Éñ„É´", subCategories: ["Ë®≠ÂÇôÊïÖÈöú", "ÊùêÊñô‰∏çËâØ", "ÂìÅË≥™Áï∞Â∏∏", "„Åù„ÅÆ‰ªñ"] }, "‰ºëÊÜ©"] },
            },
            breakAlerts: ['10:00', '11:45', '15:00'],
            maxSessionMin: 540,
            maxSessionAction: 'stop',
            centerIdleAction: 'resume',
            quickResumeMin: 10
        };

        // Geometry
        const INNER_R = 80;
        const OUTER_R = 210;
        const LINE_INNER_R = 210;
        const LINE_OUTER_R = 280;

        /* ================= UTILS ================= */
        const uuid = () => Math.random().toString(36).substring(2) + Date.now().toString(36);

        const formatDuration = (ms) => {
            const sec = Math.max(0, Math.floor(ms / 1000));
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            const pad = (n) => String(n).padStart(2, '0');
            if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
            return `${pad(m)}:${pad(s)}`;
        };

        const formatDateTime = (ms) => new Date(ms).toLocaleString('ja-JP');
        const formatDurationVerbose = (start, end) => {
            const sec = Math.max(0, Math.round((end - start) / 1000));
            if (sec < 60) return `${sec}Áßí`;
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return s > 0 ? `${m}ÂàÜ${s}Áßí` : `${m}ÂàÜ`;
        };

        const annularSector = (r1, r2, a0, a1) => {
            const large = (a1 - a0) > Math.PI ? 1 : 0;
            const x0o = r2 * Math.cos(a0), y0o = r2 * Math.sin(a0);
            const x1o = r2 * Math.cos(a1), y1o = r2 * Math.sin(a1);
            const x1i = r1 * Math.cos(a1), y1i = r1 * Math.sin(a1);
            const x0i = r1 * Math.cos(a0), y0i = r1 * Math.sin(a0);
            return `M ${x0o.toFixed(2)} ${y0o.toFixed(2)} A ${r2} ${r2} 0 ${large} 1 ${x1o.toFixed(2)} ${y1o.toFixed(2)} L ${x1i.toFixed(2)} ${y1i.toFixed(2)} A ${r1} ${r1} 0 ${large} 0 ${x0i.toFixed(2)} ${y0i.toFixed(2)} Z`;
        };

        const getLabelCoords = (r1, r2, a0, a1) => {
            const rMid = (r1 + r2) / 2;
            const aMid = (a0 + a1) / 2;
            return { x: rMid * Math.cos(aMid), y: rMid * Math.sin(aMid) };
        };

        // Category Helper Functions
        const getCategoryName = (cat) => typeof cat === 'string' ? cat : cat.name;
        const hasSubCategories = (cat) => typeof cat === 'object' && cat.subCategories && cat.subCategories.length > 0;
        const getSubCategories = (cat) => hasSubCategories(cat) ? cat.subCategories : [];

        /* ================= COMPONENTS ================= */

        /* --- Wheel --- */
        const Wheel = ({ currentLine, categories, lineNames, isTracking, currentTask, activeSessions, isEditMode, onTaskClick, onLineClick, onCenterClick }) => {
            const n = categories.length;
            const offset = -Math.PI / 2;
            const currentColor = LINE_COLORS[currentLine];
            const [hoveredTask, setHoveredTask] = useState(null);

            const taskSegments = useMemo(() => {
                return categories.map((cat, i) => {
                    const catName = getCategoryName(cat);
                    const a0 = offset + (2 * Math.PI * i) / n;
                    const a1 = offset + (2 * Math.PI * (i + 1)) / n;
                    const d = annularSector(INNER_R, OUTER_R, a0, a1);
                    const { x, y } = getLabelCoords(INNER_R, OUTER_R, a0, a1);
                    const isCurrentTask = !isEditMode && isTracking && currentTask.startsWith(catName);
                    const hasSubs = hasSubCategories(cat);

                    const handleClick = () => {
                        if (isEditMode) return;
                        if (hasSubs) {
                            // Don't directly select if has sub-categories - wait for sub selection
                            return;
                        }
                        onTaskClick(catName);
                    };

                    const handleMouseEnter = () => {
                        if (!isEditMode && hasSubs) {
                            setHoveredTask({ cat, index: i, a0, a1 });
                        }
                    };

                    const handleMouseLeave = () => {
                        if (!hasSubs) {
                            setHoveredTask(null);
                        }
                    };

                    return (
                        <g key={i}
                            className={`group ${isEditMode ? 'cursor-not-allowed opacity-40' : 'cursor-pointer'}`}
                            onClick={handleClick}
                            onMouseEnter={handleMouseEnter}
                            onMouseLeave={handleMouseLeave}>
                            <path d={d} className={`stroke-[1.5px] stroke-slate-900 transition-all duration-200 ${isCurrentTask ? 'fill-slate-800' : 'fill-slate-900/80 hover:fill-slate-800'}`} />
                            <text x={x} y={y} className={`pointer-events-none text-[14px] font-bold tracking-wide select-none transition-colors ${isCurrentTask ? 'fill-white glow-text' : 'fill-slate-400 group-hover:fill-slate-200'}`} textAnchor="middle" dominantBaseline="middle">{catName}</text>
                        </g>
                    );
                });
            }, [categories, n, offset, onTaskClick, currentColor, isTracking, currentTask, isEditMode]);

            const lineSegments = useMemo(() => {
                const ln = LINES.length;
                return LINES.map((line, i) => {
                    const a0 = offset + (2 * Math.PI * i) / ln;
                    const a1 = offset + (2 * Math.PI * (i + 1)) / ln;
                    const isActiveLine = line === currentLine;
                    const isRunning = !!activeSessions[line];
                    const lineColor = LINE_COLORS[line];
                    const rOuter = isActiveLine ? LINE_OUTER_R + 8 : LINE_OUTER_R;
                    const d = annularSector(LINE_INNER_R, rOuter, a0, a1);
                    const { x, y } = getLabelCoords(LINE_INNER_R, LINE_OUTER_R, a0, a1);

                    return (
                        <g key={line} className="group cursor-pointer" onClick={(e) => { e.stopPropagation(); onLineClick(line); }}>
                            <path d={d} className={`stroke-[2px] stroke-slate-950 transition-all duration-300 ${isEditMode ? 'hover:brightness-125' : ''}`} style={{ fill: isEditMode ? '#1e293b' : (isActiveLine ? lineColor : '#1e293b'), fillOpacity: isEditMode ? 1 : (isActiveLine ? 1 : 0.6), stroke: isEditMode ? lineColor : '#020617', strokeDasharray: isEditMode ? '4 2' : 'none' }} />
                            <text x={x} y={isActiveLine && !isEditMode ? y - 8 : y} className={`pointer-events-none text-[16px] font-black select-none transition-all ${(isActiveLine && !isEditMode) || isEditMode ? 'fill-white' : 'fill-slate-500 group-hover:fill-slate-300'}`} textAnchor="middle" dominantBaseline="middle" style={(isActiveLine && !isEditMode) ? { textShadow: `0 0 15px ${lineColor}` } : {}}>{lineNames[line]}</text>
                            {isEditMode && <g transform={`translate(${x}, ${y + 20})`}><circle r={12} fill={lineColor} /><Pencil size={12} className="text-slate-950 -ml-[6px] -mt-[6px]" /></g>}
                            {!isEditMode && isRunning && !isActiveLine && <g transform={`translate(${x}, ${y + 18})`}><circle r={4} fill={lineColor} className="animate-pulse" /></g>}
                            {!isEditMode && isActiveLine && <text x={x} y={y + 12} className="pointer-events-none text-[10px] fill-white/90 font-mono tracking-widest uppercase" textAnchor="middle" dominantBaseline="middle">{isRunning ? 'RUNNING' : 'SELECT'}</text>}
                        </g>
                    );
                });
            }, [lineNames, onLineClick, offset, currentLine, activeSessions, isEditMode]);

            return (
                <div className="relative w-[600px] h-[600px] z-10 mx-auto no-select flex items-center justify-center">
                    <div className={`absolute inset-0 rounded-full border transition-all duration-500 ${isEditMode ? 'border-dashed border-blue-500/30 scale-105' : 'border-slate-800/50 scale-95'}`}></div>
                    <div className={`absolute inset-0 rounded-full border border-slate-800/30 scale-110 pointer-events-none ${isEditMode ? '' : 'border-dashed animate-[spin_60s_linear_infinite]'}`}></div>
                    <svg className={`absolute w-[600px] h-[600px] overflow-visible drop-shadow-[0_0_15px_rgba(0,0,0,0.5)] transition-all duration-300 ${isEditMode ? 'scale-95' : ''}`} viewBox="-300 -300 600 600">
                        <g>{taskSegments}</g>
                        <g className="origin-center">{lineSegments}</g>

                        {/* Sub-Category Wheel - rendered AFTER lineSegments for correct z-order */}
                        {hoveredTask && (
                            <g onMouseLeave={() => setHoveredTask(null)}>
                                {getSubCategories(hoveredTask.cat).map((sub, j) => {
                                    const subs = getSubCategories(hoveredTask.cat);
                                    const subN = subs.length;
                                    const parentAngle = hoveredTask.a1 - hoveredTask.a0;
                                    const subAngle = parentAngle / subN;
                                    const sa0 = hoveredTask.a0 + subAngle * j;
                                    const sa1 = hoveredTask.a0 + subAngle * (j + 1);
                                    const SUB_INNER = LINE_OUTER_R + 10;
                                    const SUB_OUTER = SUB_INNER + 70;
                                    const subD = annularSector(SUB_INNER, SUB_OUTER, sa0, sa1);
                                    const { x: sx, y: sy } = getLabelCoords(SUB_INNER, SUB_OUTER, sa0, sa1);

                                    return (
                                        <g key={j}
                                            className="cursor-pointer"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                onTaskClick(`${getCategoryName(hoveredTask.cat)}:${sub}`);
                                                setHoveredTask(null);
                                            }}>
                                            <path
                                                d={subD}
                                                fill={currentColor}
                                                fillOpacity={0.85}
                                                stroke="#020617"
                                                strokeWidth={2}
                                                className="hover:fill-opacity-100 transition-all duration-200"
                                            />
                                            <text
                                                x={sx}
                                                y={sy}
                                                className="text-[12px] font-bold fill-white pointer-events-none select-none"
                                                textAnchor="middle"
                                                dominantBaseline="middle"
                                            >
                                                {sub}
                                            </text>
                                        </g>
                                    );
                                })}
                            </g>
                        )}
                    </svg>
                    <div className="absolute z-20">
                        <button onClick={onCenterClick} className={`relative group w-[160px] h-[160px] rounded-full flex items-center justify-center text-white transition-all duration-200 transform overflow-hidden ${isEditMode ? 'bg-slate-800 hover:bg-slate-700 border-4 border-slate-600' : 'active:scale-95'}`} style={!isEditMode ? { boxShadow: isTracking ? `0 0 30px ${currentColor}40, inset 0 0 20px rgba(0,0,0,0.5)` : `0 0 0 4px ${currentColor}, inset 0 0 20px rgba(0,0,0,0.8)` } : {}}>
                            <div className={`absolute inset-0 bg-slate-900 ${isEditMode ? 'opacity-100' : ''}`}></div>
                            {!isEditMode && (
                                <>
                                    {isTracking && <div className="absolute inset-0 opacity-20 animate-[spin_4s_linear_infinite]" style={{ background: `conic-gradient(from 0deg, transparent 0%, ${currentColor} 50%, transparent 100%)` }}></div>}
                                    <div className="relative z-10 flex flex-col items-center justify-center">
                                        <div className="px-2 py-0.5 rounded text-[10px] font-bold tracking-[0.2em] mb-1" style={{ backgroundColor: isTracking ? currentColor : '#334155', color: isTracking ? '#000' : '#94a3b8' }}>{isTracking ? 'REC' : 'IDLE'}</div>
                                        <span className="text-2xl font-black text-center leading-none tracking-tight drop-shadow-md mt-1">{isTracking ? currentTask : 'START'}</span>
                                        {!isTracking && <span className="text-[10px] text-slate-500 mt-2 uppercase tracking-wide">Select Task</span>}
                                        {isTracking && <Activity className="w-5 h-5 mt-2 animate-pulse text-white/80" />}
                                    </div>
                                </>
                            )}
                            {isEditMode && <div className="relative z-10 flex flex-col items-center justify-center text-slate-300"><span className="text-xl font-black mb-1">EXIT EDIT</span><span className="text-[10px] uppercase tracking-wider text-slate-500">Close Settings</span></div>}
                            <div className="absolute inset-0 rounded-full bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>
                        </button>
                    </div>
                </div>
            );
        };

        /* --- Modals --- */
        const PromptModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[1300] backdrop-blur-sm">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-6 w-[90vw] max-w-[400px]">
                        <p className="text-slate-200 text-base mb-6 font-medium">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-300 bg-slate-800 hover:bg-slate-700 rounded-lg font-bold text-sm transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onClick={onConfirm} className="px-4 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/20 transition-all hover:scale-105">OK</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LogModal = ({ isOpen, onClose, logs }) => {
            const [query, setQuery] = useState('');
            if (!isOpen) return null;
            const filteredLogs = logs.filter(l => {
                const q = query.toLowerCase();
                return (l.task.toLowerCase().includes(q) || l.line.toLowerCase().includes(q) || l.lineName.toLowerCase().includes(q) || (l.reason && l.reason.toLowerCase().includes(q)));
            }).sort((a, b) => b.endedAt - a.endedAt).slice(0, 500);

            return (
                <div className="fixed inset-0 bg-[#020617]/95 backdrop-blur-md z-[1200] flex flex-col text-slate-200">
                    <div className="flex items-center gap-4 p-4 border-b border-slate-800 bg-[#0f152a]">
                        <h2 className="text-lg font-bold text-white shrink-0 flex items-center gap-2"><FileDown className="w-5 h-5 text-blue-400" />„É≠„Ç∞Â±•Ê≠¥</h2>
                        <div className="flex-1 relative max-w-md ml-auto">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                            <input type="text" placeholder="Ê§úÁ¥¢..." value={query} onChange={e => setQuery(e.target.value)} className="w-full bg-[#1a2238] border border-slate-700 rounded-lg py-2 pl-9 pr-4 text-sm text-slate-100 focus:outline-none focus:border-blue-500" />
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"><X className="w-6 h-6" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        <div className="max-w-5xl mx-auto grid gap-2">
                            {filteredLogs.map(log => (
                                <div key={log.id} className="grid grid-cols-[100px_1fr] md:grid-cols-[120px_1fr_1fr] gap-x-4 gap-y-1 p-3 rounded-lg border border-slate-800 bg-slate-900/50 text-xs md:text-sm">
                                    <div className="flex items-center">
                                        <span className="px-2 py-0.5 rounded text-[10px] font-bold text-slate-950 mr-2" style={{ backgroundColor: LINE_COLORS[log.line] }}>{log.line}</span>
                                        <span className="truncate opacity-80 font-mono text-xs">{log.lineName}</span>
                                    </div>
                                    <div className="font-bold text-white">{log.task}{log.memo && <span className="ml-2 text-slate-400 font-normal text-xs flex items-center gap-1"><MessageSquare size={10} />{log.memo}</span>}</div>
                                    <div className="col-span-2 md:col-span-1 text-slate-400 font-mono text-xs flex items-center gap-2 justify-end">
                                        {formatDateTime(log.startedAt)} ‚Üí {formatDateTime(log.endedAt)}
                                        <span className="ml-3 text-blue-300 font-bold">({formatDurationVerbose(log.startedAt, log.endedAt)})</span>
                                    </div>
                                </div>
                            ))}
                            {filteredLogs.length === 0 && <div className="text-center py-20 text-slate-600 font-mono">NO LOGS FOUND</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const LineSettingsModal = ({ isOpen, onClose, lineId, config, onSave }) => {
            const [name, setName] = useState('');
            const [cats, setCats] = useState('');
            useEffect(() => {
                if (isOpen && config.lines[lineId]) {
                    setName(config.lines[lineId].name);
                    setCats(config.lines[lineId].categories.join('\n'));
                }
            }, [isOpen, lineId, config]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[1300] backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-[90vw] max-w-[480px] overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-950">
                            <div className="flex items-center gap-3">
                                <span className="flex items-center justify-center w-8 h-8 rounded font-black text-slate-950" style={{ backgroundColor: LINE_COLORS[lineId] }}>{lineId}</span>
                                <h2 className="text-lg font-bold text-white">„É©„Ç§„É≥Ë®≠ÂÆö</h2>
                            </div>
                            <button onClick={onClose}><X className="text-slate-500 hover:text-white" /></button>
                        </div>
                        <div className="p-6 flex flex-col gap-6">
                            <label className="flex flex-col gap-2">
                                <span className="text-xs font-bold text-slate-400 uppercase">„É©„Ç§„É≥ÂêçÁß∞</span>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-lg p-3 text-white font-bold focus:outline-none focus:border-blue-500" />
                            </label>
                            <label className="flex flex-col gap-2">
                                <span className="text-xs font-bold text-slate-400 uppercase">„Çø„Çπ„ÇØÈ†ÖÁõÆ (ÊîπË°åÂå∫Âàá„Çä)</span>
                                <textarea value={cats} onChange={e => setCats(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 font-mono h-[200px] focus:outline-none focus:border-blue-500 resize-none custom-scrollbar" />
                            </label>
                        </div>
                        <div className="p-4 bg-slate-950 border-t border-slate-800 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-slate-400 hover:text-white font-bold text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onClick={() => { onSave(lineId, name, cats.split('\n').map(s => s.trim()).filter(s => s.length > 0)); }} className="flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold"><Save size={16} /> ‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalSettingsModal = ({ isOpen, onClose, config, onSave, onReset }) => {
            const [localConfig, setLocalConfig] = useState(config);
            useEffect(() => { if (isOpen) setLocalConfig(JSON.parse(JSON.stringify(config))); }, [isOpen, config]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[1300] backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-slate-950 border border-slate-700 rounded-xl shadow-2xl w-[95vw] max-w-[600px] max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-900">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Settings2 className="w-5 h-5 text-blue-400" />„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</h2>
                            <button onClick={onClose}><X className="text-slate-500 hover:text-white" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar flex flex-col gap-8">

                            <section>
                                <h3 className="text-xs font-bold text-blue-400 uppercase mb-4 border-b border-slate-800 pb-2">‚è∞ „Çø„Ç§„Éû„ÉºÔºÜ„Ç¢„É©„Éº„Éà</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-bold text-slate-300 block mb-2">ÊúÄÂ§ßÈÄ£Á∂öË®àÊ∏¨ÊôÇÈñì (ÂàÜ)</label>
                                        <div className="flex gap-4 items-center">
                                            <input type="number" value={localConfig.maxSessionMin || 540} onChange={e => setLocalConfig({ ...localConfig, maxSessionMin: parseInt(e.target.value) })} className="bg-slate-900 border border-slate-700 rounded p-2 text-white w-24" />
                                            <span className="text-slate-500 text-xs">‚Äª„Éá„Éï„Ç©„É´„Éà540ÂàÜ (9ÊôÇÈñì)</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-sm font-bold text-slate-300 block mb-2">‰∏äÈôêÂà∞ÈÅîÊôÇ„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥</label>
                                        <select value={localConfig.maxSessionAction || 'stop'} onChange={e => setLocalConfig({ ...localConfig, maxSessionAction: e.target.value })} className="bg-slate-900 border border-slate-700 rounded p-2 text-white w-full">
                                            <option value="stop">Ëá™ÂãïÁµÇ‰∫Ü (Auto Stop)</option>
                                            <option value="confirm">Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-sm font-bold text-slate-300 block mb-2">‰ºëÊÜ©ÊôÇÈñìÊ°àÂÜÖ (ÊôÇÂàª)</label>
                                        <div className="flex gap-2 flex-wrap">
                                            {(localConfig.breakAlerts || ['10:00', '11:45', '15:00']).map((val, i) => (
                                                <input key={i} type="time" value={val} onChange={e => {
                                                    const newAlerts = [...(localConfig.breakAlerts || ['10:00', '11:45', '15:00'])];
                                                    newAlerts[i] = e.target.value;
                                                    setLocalConfig({ ...localConfig, breakAlerts: newAlerts });
                                                }} className="bg-slate-900 border border-slate-700 rounded p-2 text-white" />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 className="text-xs font-bold text-blue-400 uppercase mb-4 border-b border-slate-800 pb-2">üéÆ Êìç‰ΩúË®≠ÂÆö</h3>
                                <div>
                                    <label className="text-sm font-bold text-slate-300 block mb-2">‰∏≠Â§Æ„Éú„Çø„É≥(„Ç¢„Ç§„Éâ„É´ÊôÇ)„ÅÆÂãï‰Ωú</label>
                                    <select value={localConfig.centerIdleAction || 'resume'} onChange={e => setLocalConfig({ ...localConfig, centerIdleAction: e.target.value })} className="bg-slate-900 border border-slate-700 rounded p-2 text-white w-full">
                                        <option value="none">‰Ωï„ÇÇ„Åó„Å™„ÅÑ</option>
                                        <option value="resume">Áõ¥Ââç„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÜçÈñã</option>
                                    </select>
                                </div>
                            </section>

                            <section>
                                <h3 className="text-xs font-bold text-blue-400 uppercase mb-4 border-b border-slate-800 pb-2">üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => { if (confirm('„Åô„Åπ„Å¶„ÅÆË®≠ÂÆö„Å®„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) onReset(); }} className="flex flex-col items-center gap-2 p-3 bg-red-900/10 hover:bg-red-900/30 rounded-lg border border-red-900/30 hover:border-red-500/50 transition-all"><RotateCcw size={20} className="text-red-500" /><span className="text-xs font-bold text-red-400">„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ</span></button>
                                </div>
                            </section>
                        </div>
                        <div className="p-4 bg-slate-900 border-t border-slate-800 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-slate-400 hover:text-white font-bold text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onClick={() => onSave(localConfig)} className="flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold"><Save size={16} /> ‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        /* --- Help Modal --- */
        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[1300] backdrop-blur-md" onClick={onClose}>
                    <div className="bg-slate-950 border border-slate-700 rounded-xl shadow-2xl w-[95vw] max-w-[700px] max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between p-5 border-b border-slate-800 bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-3"><HelpCircle className="w-6 h-6 text-blue-400" />‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h2>
                            <button onClick={onClose}><X className="text-slate-500 hover:text-white" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-8 custom-scrollbar text-slate-300">
                            <div className="grid md:grid-cols-2 gap-8 mb-8">
                                <section>
                                    <h3 className="flex items-center gap-2 text-white font-bold text-lg mb-4 border-b border-slate-800 pb-2"><Activity className="text-emerald-400 w-5 h-5" /> Âü∫Êú¨ÁöÑ„Å™‰Ωø„ÅÑÊñπ</h3>
                                    <div className="space-y-4">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                            <div className="font-bold text-white mb-1">1. „Çø„Çπ„ÇØ„ÇíÈñãÂßã„Åô„Çã</div>
                                            <p className="text-xs">‰∏≠Â§Æ„ÅÆ„Éõ„Ç§„Éº„É´„Å´„ÅÇ„Çã‰ΩúÊ•≠Âêç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Ë®àÊ∏¨„ÅåÂßã„Åæ„Çä„Åæ„Åô„ÄÇ„Äå„Éà„É©„Éñ„É´„Äç„Å™„Å©„ÅÆ‰∏ÄÈÉ®È†ÖÁõÆ„ÅØ„ÄÅ„Åï„Çâ„Å´Ë©≥Á¥∞„Å™ÁêÜÁî±„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                            <div className="font-bold text-white mb-1">2. Ë®àÊ∏¨„ÇíÊ≠¢„ÇÅ„Çã</div>
                                            <p className="text-xs">‰∏≠Â§Æ„ÅÆÂ§ß„Åç„Å™ÂÜÜ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅ„Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÇíÊäº„Åô„Å®Ë®àÊ∏¨„ÅåÂÅúÊ≠¢ÔºàIDLEÁä∂ÊÖãÔºâ„Åó„Åæ„Åô„ÄÇ</p>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                            <div className="font-bold text-white mb-1">3. „É©„Ç§„É≥„ÇíÂàá„ÇäÊõø„Åà„Çã</div>
                                            <p className="text-xs">‰∏ÄÁï™Â§ñÂÅ¥„ÅÆ„É™„É≥„Ç∞(A, B, C...)„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅ„Ç≠„Éº„Éú„Éº„Éâ„ÅÆÊï∞Â≠ó„Ç≠„Éº(1„Äú5)„Åß„É©„Ç§„É≥„ÇíÂç≥Â∫ß„Å´Âàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô„ÄÇ</p>
                                        </div>
                                    </div>
                                </section>
                                <section>
                                    <h3 className="flex items-center gap-2 text-white font-bold text-lg mb-4 border-b border-slate-800 pb-2"><Settings className="text-blue-400 w-5 h-5" /> Ë®≠ÂÆö„Å®Â±•Ê≠¥</h3>
                                    <div className="space-y-4">
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                            <div className="font-bold text-white mb-1">‚öôÔ∏è Ë®≠ÂÆöÂ§âÊõ¥</div>
                                            <p className="text-xs">Âè≥‰∏ä„ÅÆÊ≠ØËªä„Ç¢„Ç§„Ç≥„É≥„Åß„ÄåÁ∑®ÈõÜ„É¢„Éº„Éâ„Äç„Å´„Å™„Çä„Åæ„Åô„ÄÇ„É¢„Éº„Éâ‰∏≠„Å´ÂêÑ„Ç®„É™„Ç¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Ë®≠ÂÆö„ÅåÈñã„Åç„Åæ„Åô„ÄÇ</p>
                                            <ul className="list-disc list-inside text-[10px] mt-1 text-slate-400">
                                                <li>Â§ñÂÅ¥„É™„É≥„Ç∞ ‚Üí ÂêÑ„É©„Ç§„É≥„ÅÆÂêçÁß∞„Éª„Çø„Çπ„ÇØÁ∑®ÈõÜ</li>
                                                <li>‰∏ã„ÅÆ„Éë„Éç„É´ ‚Üí ÂÖ®‰ΩìË®≠ÂÆöÔºàÊôÇÈñìË®≠ÂÆö„Å™„Å©Ôºâ</li>
                                            </ul>
                                        </div>
                                        <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                                            <div className="font-bold text-white mb-1">üìÑ Â±•Ê≠¥„Å®Âá∫Âäõ</div>
                                            <p className="text-xs">Âè≥‰∏ä„ÅÆÊõ∏È°û„Ç¢„Ç§„Ç≥„É≥„ÅßÂ±•Ê≠¥„ÇíË°®Á§∫„ÄÅ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç¢„Ç§„Ç≥„É≥„ÅßCSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            <section className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/20">
                                <h3 className="text-blue-300 font-bold mb-2 flex items-center gap-2"><Keyboard className="w-4 h-4" /> „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº</h3>
                                <div className="grid grid-cols-3 gap-2 text-xs font-mono text-slate-300">
                                    <div className="bg-slate-900 p-2 rounded text-center border border-slate-700"><span className="text-white font-bold">1-5</span> „É©„Ç§„É≥ÂàáÊõø</div>
                                    <div className="bg-slate-900 p-2 rounded text-center border border-slate-700"><span className="text-white font-bold">Space</span> ÂÅúÊ≠¢/ÂÜçÈñã</div>
                                    <div className="bg-slate-900 p-2 rounded text-center border border-slate-700"><span className="text-white font-bold">Esc</span> Èñâ„Åò„Çã</div>
                                </div>
                            </section>
                        </div>
                        <div className="p-5 bg-slate-900 border-t border-slate-800 flex justify-center">
                            <button onClick={onClose} className="px-10 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg shadow-blue-900/20 text-lg transition-all hover:scale-105">ÁêÜËß£„Åó„Åæ„Åó„Åü</button>
                        </div>
                    </div>
                </div>
            );
        };

        /* ================= MAIN APP ================= */
        const App = () => {
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [currentLine, setCurrentLine] = useState('A');
            const [activeSessions, setActiveSessions] = useState({ A: null, B: null, C: null, D: null, E: null });
            const [lastEnded, setLastEnded] = useState({ A: null, B: null, C: null, D: null, E: null });
            const [now, setNow] = useState(Date.now());
            const [undoInfo, setUndoInfo] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);
            const [promptState, setPromptState] = useState({ isOpen: false, message: '', onConfirm: () => { }, onCancel: () => { } });
            const [isLogOpen, setIsLogOpen] = useState(false);
            const [editingLine, setEditingLine] = useState(null);
            const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
            const [isHelpOpen, setIsHelpOpen] = useState(false);
            const undoTimerRef = useRef(null);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('wheel_config_v2');
                    if (saved) setConfig({ ...DEFAULT_CONFIG, ...JSON.parse(saved) });
                } catch (e) { }
            }, []);
            useEffect(() => {
                const timer = setInterval(() => {
                    const currentNow = Date.now();
                    setNow(currentNow);

                    // Max Session Logic
                    const maxMin = config.maxSessionMin || 540;
                    const action = config.maxSessionAction || 'stop';

                    Object.entries(activeSessions).forEach(([line, session]) => {
                        if (session) {
                            const elapsedMin = (currentNow - session.startedAt) / 60000;
                            if (elapsedMin >= maxMin) {
                                if (action === 'stop') {
                                    // Check if we haven't already just stopped it (to prevent loops if state updates lag slightly, though activeSessions check handles it)
                                    stopTracking(line, 'ÊúÄÂ§ßÊôÇÈñìÁµåÈÅé„Å´„Çà„ÇãËá™ÂãïÁµÇ‰∫Ü');
                                }
                                // If action is 'confirm', we relies on the UI to show alert (red blinking timer) rather than a blocking modal loop
                            }
                        }
                    });

                }, 1000);
                return () => clearInterval(timer);
            }, [activeSessions, config]);
            useEffect(() => { localStorage.setItem('wheel_config_v2', JSON.stringify(config)); }, [config]);

            const getLogs = (line) => { try { return JSON.parse(localStorage.getItem(`timelogs_v2_${line}`) || '[]'); } catch { return []; } };
            const getAllLogs = () => LINES.flatMap(line => getLogs(line));
            const saveLog = (line, log) => {
                const logs = getLogs(line); logs.push(log);
                localStorage.setItem(`timelogs_v2_${line}`, JSON.stringify(logs));
                setLastEnded(prev => ({ ...prev, [line]: { task: log.task, endedAt: log.endedAt } }));
            };
            const removeLog = (line, logId) => {
                const logs = getLogs(line);
                localStorage.setItem(`timelogs_v2_${line}`, JSON.stringify(logs.filter(l => l.id !== logId)));
            };

            const startTracking = (line, task) => {
                const active = activeSessions[line];
                if (active) {
                    const log = { id: uuid(), line, lineName: config.lines[line].name, task: active.task, startedAt: active.startedAt, endedAt: Date.now() };
                    saveLog(line, log);
                    showUndo({ type: 'autostop', line, log });
                }
                setActiveSessions(prev => ({ ...prev, [line]: { task, startedAt: Date.now() } }));
            };
            const stopTracking = (line, reason) => {
                const active = activeSessions[line];
                if (!active) return;
                const log = { id: uuid(), line, lineName: config.lines[line].name, task: active.task, startedAt: active.startedAt, endedAt: Date.now(), reason };
                saveLog(line, log);
                setActiveSessions(prev => ({ ...prev, [line]: null }));
                showUndo({ type: 'stop', line, log });
            };
            const showUndo = (info) => {
                setUndoInfo(info);
                if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
                undoTimerRef.current = setTimeout(() => setUndoInfo(null), 3000);
            };
            const handleUndo = () => {
                if (!undoInfo) return;
                const { line, log } = undoInfo;
                removeLog(line, log.id);
                setActiveSessions(prev => ({ ...prev, [line]: { task: log.task, startedAt: log.startedAt } }));
                setUndoInfo(null);
            };
            const handleCsvExport = () => {
                const all = getAllLogs().sort((a, b) => a.startedAt - b.startedAt);
                const header = ['„É©„Ç§„É≥ID', '„É©„Ç§„É≥Âêç', '„Çø„Çπ„ÇØ', 'ÈñãÂßãÊó•ÊôÇ', 'ÁµÇ‰∫ÜÊó•ÊôÇ', 'ÊâÄË¶ÅÊôÇÈñì(Áßí)', 'ÁêÜÁî±'];
                const rows = all.map(l => {
                    const dur = Math.round((l.endedAt - l.startedAt) / 1000);
                    const esc = (s) => `"${String(s || '').replace(/"/g, '""')}"`;
                    return [l.line, esc(l.lineName), esc(l.task), esc(new Date(l.startedAt).toLocaleString('ja-JP')), esc(new Date(l.endedAt).toLocaleString('ja-JP')), dur, esc(l.reason)].join(',');
                });
                const blob = new Blob([[header.join(','), ...rows].join('\n')], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `timelogs_${new Date().toISOString().slice(0, 10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const handleWheelTaskClick = (task) => { if (!isEditMode) startTracking(currentLine, task); };
            const handleWheelLineClick = (line) => { if (isEditMode) setEditingLine(line); else setCurrentLine(line); };
            const handleCenterClick = () => {
                if (isEditMode) { setIsEditMode(false); return; }
                if (activeSessions[currentLine]) { stopTracking(currentLine); return; }

                // Idle Action Logic
                const idleAction = config.centerIdleAction || 'resume';
                if (idleAction === 'none') return;

                const last = lastEnded[currentLine];
                if (last && (Date.now() - last.endedAt) <= (config.quickResumeMin || 10) * 60000) startTracking(currentLine, last.task);
            };

            const lineConf = config.lines[currentLine];
            const currentSession = activeSessions[currentLine];
            const currentColor = LINE_COLORS[currentLine];

            return (
                <div className={`min-h-screen flex flex-col items-center justify-between p-6 relative overflow-hidden bg-slate-950 ${isEditMode ? 'ring-8 ring-inset ring-blue-500/20' : ''}`}>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full opacity-10 blur-[100px] pointer-events-none" style={{ backgroundColor: currentColor }} />

                    <header className="w-full max-w-[1200px] flex justify-between items-start z-30">
                        <div className="flex flex-col">
                            <div className="flex items-center gap-2 text-slate-100">{isEditMode ? <PenTool className="w-6 h-6 text-blue-400" /> : <LayoutDashboard className="w-6 h-6 text-slate-400" />}<h1 className="text-xl font-bold">{isEditMode ? 'EDIT MODE' : 'PRODUCTION HUD'}</h1></div>
                            <p className="text-slate-500 text-xs font-mono mt-1 ml-8">{isEditMode ? 'CLICK ELEMENT TO CONFIGURE' : `SYSTEM READY // ${new Date(now).toLocaleTimeString()}`}</p>
                        </div>
                        <div className="flex items-center gap-3">
                            {isEditMode && (
                                <>
                                    <div className="flex items-center gap-2 px-3 py-2 bg-slate-900/50 backdrop-blur rounded-lg border border-slate-800">
                                        <span className="w-3 h-3 rounded-full" style={{ backgroundColor: currentColor }}></span>
                                        <span className="text-xs font-bold text-slate-300">{currentLine}</span>
                                    </div>
                                    <button onClick={() => setIsHelpOpen(true)} className="p-3 bg-slate-900/50 backdrop-blur rounded-lg border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all"><HelpCircle className="w-5 h-5" /></button>
                                    <button onClick={() => setIsLogOpen(true)} className="p-3 bg-slate-900/50 backdrop-blur rounded-lg border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all"><FileText className="w-5 h-5" /></button>
                                    <button onClick={handleCsvExport} className="p-3 bg-slate-900/50 backdrop-blur rounded-lg border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all"><Download className="w-5 h-5" /></button>
                                </>
                            )}
                            <button onClick={() => setIsEditMode(!isEditMode)} className={`p-3 backdrop-blur rounded-lg border transition-all ${isEditMode ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-900/50 border-slate-800 text-slate-400 hover:text-white hover:border-slate-600'}`}><Settings className={`w-5 h-5 ${isEditMode ? 'animate-spin' : ''}`} /></button>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col items-center justify-center w-full relative z-20 scale-90 sm:scale-100 xl:scale-110">
                        {isEditMode && <div className="absolute -top-6 text-blue-400 text-sm font-bold animate-bounce uppercase tracking-widest">Click Ring to Edit Line</div>}
                        <Wheel currentLine={currentLine} categories={lineConf.categories} lineNames={Object.fromEntries(LINES.map(l => [l, config.lines[l].name]))} isTracking={!!currentSession} currentTask={currentSession?.task || ''} activeSessions={activeSessions} isEditMode={isEditMode} onTaskClick={handleWheelTaskClick} onLineClick={handleWheelLineClick} onCenterClick={handleCenterClick} />
                    </main>

                    <div className={`w-full max-w-[900px] z-30 mb-4 ${isEditMode ? 'cursor-pointer hover:scale-[1.02]' : ''}`} onClick={() => isEditMode && setIsGlobalSettingsOpen(true)}>
                        <div className={`bg-slate-900/80 backdrop-blur-md border rounded-xl p-4 shadow-2xl relative overflow-hidden ${isEditMode ? 'border-blue-500/50 border-dashed' : 'border-slate-800'}`}>
                            {isEditMode && <div className="absolute inset-0 flex items-center justify-center bg-black/40 text-blue-400 font-black text-lg tracking-widest z-50">EDIT GLOBAL SETTINGS</div>}
                            <div className="absolute top-0 left-0 w-1 h-full" style={{ backgroundColor: currentColor }}></div>
                            <div className="flex items-center justify-between gap-8">
                                <div className="flex items-center gap-4">
                                    <div className="px-3 py-1 rounded text-sm font-bold text-slate-950" style={{ backgroundColor: currentColor }}>{currentLine}</div>
                                    <div><div className="text-slate-500 text-xs font-bold uppercase">Line</div><div className="text-lg font-black text-white">{config.lines[currentLine].name}</div></div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="p-2 rounded-lg bg-slate-950 border border-slate-800 text-slate-300"><Clock className="w-5 h-5" /></div>
                                    <div><div className="text-slate-500 text-xs uppercase font-bold">Activity</div><div className={`text-base font-semibold ${currentSession ? 'text-white' : 'text-slate-600'}`}>{currentSession ? currentSession.task : 'System Idle'}</div></div>
                                </div>
                                <div className="text-right">
                                    <div className="text-slate-400 text-xs font-bold uppercase">Elapsed</div>
                                    <div className="text-2xl font-mono font-medium text-white">{currentSession ? <><span className="animate-pulse text-red-500 text-xs">‚óè</span>{formatDuration(now - currentSession.startedAt)}</> : <span className="text-slate-600">--:--</span>}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {undoInfo && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-700 text-white pl-5 pr-3 py-3 rounded-full shadow-2xl flex items-center gap-6 z-[1200]">
                            <span className="text-sm font-medium">{undoInfo.type === 'stop' ? 'Task Stopped' : 'Auto Switched'}</span>
                            <button onClick={handleUndo} className="bg-slate-100 text-slate-900 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-white">UNDO</button>
                        </div>
                    )}

                    <PromptModal isOpen={promptState.isOpen} message={promptState.message} onConfirm={promptState.onConfirm} onCancel={promptState.onCancel} />
                    <LogModal isOpen={isLogOpen} onClose={() => setIsLogOpen(false)} logs={getAllLogs()} />
                    {editingLine && <LineSettingsModal isOpen={true} onClose={() => setEditingLine(null)} lineId={editingLine} config={config} onSave={(lineId, newName, newCats) => { setConfig(prev => ({ ...prev, lines: { ...prev.lines, [lineId]: { name: newName, categories: newCats } } })); setEditingLine(null); }} />}
                    <GlobalSettingsModal isOpen={isGlobalSettingsOpen} onClose={() => setIsGlobalSettingsOpen(false)} config={config} onSave={(newConf) => { setConfig(newConf); setIsGlobalSettingsOpen(false); }} onReset={() => { setConfig(DEFAULT_CONFIG); setIsGlobalSettingsOpen(false); }} />
                    <HelpModal isOpen={isHelpOpen} onClose={() => setIsHelpOpen(false)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>