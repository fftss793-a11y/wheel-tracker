<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>å·¥ç¨‹ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --primary: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #a855f7;
            --cyan: #06b6d4;
            --gray: #6b7280;
            --text: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
        }

        header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .admin-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
        }

        .admin-badge.visible {
            display: inline-block;
        }

        main {
            padding: 16px;
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .setting-row label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .setting-row input,
        .setting-row select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }

        /* Buttons */
        .button-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .main-btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 14px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .main-btn:active {
            transform: scale(0.98);
        }

        .btn-startup {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .btn-start {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-resume {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-shutdown {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .timer-display {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .timer-display.startup {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .timer-display.paused {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .timer-display.shutdown {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .timer-label {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .timer-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .timer-display.startup .timer-value {
            color: var(--purple);
        }

        .timer-display.paused .timer-value {
            color: var(--warning);
        }

        .timer-display.shutdown .timer-value {
            color: var(--gray);
        }

        /* Sub Buttons */
        .sub-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .sub-btn {
            padding: 14px 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sub-btn:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .sub-btn .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Stage Indicator */
        .stage-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
        }

        .stage-dot.active {
            background: var(--primary);
        }

        .stage-dot.completed {
            background: var(--success);
        }

        .stage-label {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 12px;
        }

        /* Log */
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .log-table th,
        .log-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .log-table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-sub);
            position: sticky;
            top: 0;
        }

        .log-table tr:last-child td {
            border-bottom: none;
        }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .kpi-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .controls button {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .controls button:hover {
            background: #f8fafc;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.visible {
            display: block;
        }

        .admin-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* Timeline */
        .timeline-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timeline-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .timeline-container {
            position: relative;
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            overflow-x: auto;
        }

        .timeline-scale {
            position: relative;
            height: 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .timeline-tick {
            position: absolute;
            font-size: 0.7rem;
            color: var(--text-sub);
            transform: translateX(-50%);
        }

        .timeline-lane {
            position: relative;
            height: 36px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .timeline-break {
            position: absolute;
            top: 0;
            height: 100%;
            background: repeating-linear-gradient(45deg,
                    rgba(148, 163, 184, 0.15),
                    rgba(148, 163, 184, 0.15) 4px,
                    transparent 4px,
                    transparent 8px);
            border-left: 2px dashed #94a3b8;
            border-right: 2px dashed #94a3b8;
        }

        .timeline-break-label {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.6rem;
            color: #64748b;
            white-space: nowrap;
        }

        .timeline-bar {
            position: absolute;
            top: 4px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            min-width: 2px;
            overflow: hidden;
            white-space: nowrap;
        }

        .timeline-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        /* Memo Input */
        .memo-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }

        .memo-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Fullscreen Overlay */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .fullscreen-overlay.hidden {
            display: none;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .fullscreen-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        .fullscreen-timeline {
            background: white;
            border-radius: 12px;
            padding: 30px;
            overflow: auto;
            width: 100%;
            max-width: 1200px;
            max-height: 70vh;
        }

        .fullscreen-lane {
            height: 80px;
        }

        .fullscreen-bar {
            height: 60px;
            font-size: 1rem;
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }

            header,
            .admin-toggle,
            .admin-badge,
            .controls,
            .stage-indicator,
            .stage-label,
            .button-area,
            #adminSettings,
            .card-header:has(+ .setting-row) {
                display: none !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            .timeline-section {
                display: block !important;
            }

            .log-container {
                max-height: none !important;
                overflow: visible !important;
            }

            .kpi-grid {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>â±ï¸ å·¥ç¨‹ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</h1>
        <span class="admin-badge" id="adminBadge">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</span>
        <button class="admin-toggle" id="adminToggle">âš™ï¸</button>
    </header>

    <main>
        <!-- Settings -->
        <section class="card">
            <div class="card-header">ğŸ“… è¨­å®š</div>
            <div class="setting-row">
                <label>æ—¥ä»˜<input type="date" id="dateInput"></label>
                <label>è£½å“<select id="productSelect">
                        <option value="2E">2E</option>
                        <option value="2J">2J</option>
                        <option value="2L">2L</option>
                        <option value="2LH">2LH</option>
                    </select></label>
            </div>

            <!-- Admin Settings (hidden by default) -->
            <div id="adminSettings" class="hidden"
                style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border);">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 8px;">ğŸ”§
                    ç®¡ç†è€…è¨­å®šï¼ˆä¼‘æ†©æ™‚é–“ãƒ»ç›®å®‰ï¼‰</div>
                <div class="setting-row" style="margin-bottom: 8px;">
                    <label>ä¼‘æ†©1<input type="time" id="break1Start" value="10:00"></label>
                    <label>æ™‚é–“(åˆ†)<input type="number" id="break1Dur" value="5" style="width: 60px;"></label>
                </div>
                <div class="setting-row" style="margin-bottom: 8px;">
                    <label>æ˜¨ä¼‘æ†©<input type="time" id="break2Start" value="11:45"></label>
                    <label>æ™‚é–“(åˆ†)<input type="number" id="break2Dur" value="45" style="width: 60px;"></label>
                </div>
                <div class="setting-row">
                    <label>ä¼‘æ†©3<input type="time" id="break3Start" value="15:00"></label>
                    <label>æ™‚é–“(åˆ†)<input type="number" id="break3Dur" value="10" style="width: 60px;"></label>
                </div>
            </div>
        </section>

        <!-- Operator Mode -->
        <section class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ¯ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰</span>
                <button id="helpBtn"
                    style="background: var(--primary); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 1rem;">?</button>
            </div>

            <div class="stage-indicator">
                <div class="stage-dot" id="stage1Dot"></div>
                <div class="stage-dot" id="stage2Dot"></div>
                <div class="stage-dot" id="stage3Dot"></div>
            </div>
            <div class="stage-label" id="stageLabel">ã‚¹ãƒ†ãƒ¼ã‚¸1: ç«‹ã¡ä¸Šã’</div>

            <!-- Stage 1: Startup -->
            <div id="stage1" class="button-area">
                <button class="main-btn btn-startup" id="startupBtn">ğŸ”§ ç«‹ã¡ä¸Šã’ é–‹å§‹</button>
            </div>

            <!-- Stage 1: Startup Running -->
            <div id="stage1Running" class="button-area hidden">
                <div class="timer-display startup">
                    <div class="timer-label">ç«‹ã¡ä¸Šã’ä¸­</div>
                    <div class="timer-value" id="startupTimer">0 åˆ†</div>
                </div>
                <button class="main-btn btn-startup" id="startupEndBtn">âœ“ ç«‹ã¡ä¸Šã’ å®Œäº†</button>
            </div>

            <!-- Stage 2: Normal Operation - Idle -->
            <div id="stage2Idle" class="button-area hidden">
                <button class="main-btn btn-start" id="runStartBtn">â–¶ï¸ ç¨¼åƒ é–‹å§‹</button>
                <button class="sub-btn" data-type="æ¬¡Lotã¸" data-color="#f59e0b" style="margin-top: 8px;">
                    <span class="dot" style="background: #f59e0b"></span>ğŸ”„ æ¬¡Lotã¸
                </button>
                <button class="main-btn btn-shutdown" id="shutdownBtn"
                    style="margin-top: 20px; font-size: 1rem; padding: 14px;">â¹ï¸ ç«‹ã¡ä¸‹ã’ é–‹å§‹</button>
            </div>

            <!-- Stage 2: Normal Operation - Running -->
            <div id="stage2Running" class="button-area hidden">
                <div class="timer-display">
                    <div class="timer-label">ç¨¼åƒä¸­</div>
                    <div class="timer-value" id="runTimer">0 åˆ†</div>
                </div>
                <button class="main-btn btn-stop" id="runStopBtn">â¹ï¸ ç¨¼åƒ çµ‚äº†</button>
                <div class="sub-buttons" id="runningEvents">
                    <button class="sub-btn" data-type="è¨­å‚™ç•°å¸¸" data-color="#ef4444">
                        <span class="dot" style="background: #ef4444"></span>è¨­å‚™ç•°å¸¸
                    </button>
                    <button class="sub-btn" data-type="éƒ¨å“äº¤æ›" data-color="#a855f7">
                        <span class="dot" style="background: #a855f7"></span>éƒ¨å“äº¤æ›
                    </button>
                </div>
            </div>

            <!-- Stage 2: Paused -->
            <div id="stage2Paused" class="button-area hidden">
                <div class="timer-display paused">
                    <div class="timer-label" id="pausedLabel">ä¸€æ™‚åœæ­¢ä¸­</div>
                    <div class="timer-value" id="pausedTimer">0 åˆ†</div>
                </div>
                <button class="main-btn btn-resume" id="resumeBtn">â–¶ï¸ å†ç¨¼åƒ</button>
            </div>

            <!-- Stage 2: Pre-run Events -->
            <div id="stage2PreEvent" class="button-area hidden">
                <div class="timer-display paused">
                    <div class="timer-label" id="preEventLabel">æ¬¡Lotã¸ æº–å‚™ä¸­</div>
                    <div class="timer-value" id="preEventTimer">0 åˆ†</div>
                </div>
                <button class="main-btn btn-start" id="preEventEndBtn">âœ“ å®Œäº† â†’ ç¨¼åƒé–‹å§‹</button>
            </div>

            <!-- Stage 3: Shutdown -->
            <div id="stage3" class="button-area hidden">
                <div class="timer-display shutdown">
                    <div class="timer-label">ç«‹ã¡ä¸‹ã’ä¸­</div>
                    <div class="timer-value" id="shutdownTimer">0 åˆ†</div>
                </div>
                <button class="main-btn btn-shutdown" id="shutdownEndBtn">âœ“ ç«‹ã¡ä¸‹ã’ å®Œäº†</button>
            </div>

            <!-- Stage 3: Complete -->
            <div id="stageComplete" class="button-area hidden">
                <div style="text-align: center; padding: 30px; background: #f0fdf4; border-radius: 12px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ‰</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);">æœ¬æ—¥ã®è¨˜éŒ²å®Œäº†</div>
                </div>
                <button class="sub-btn" id="resetBtn" style="margin-top: 12px;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆï¼ˆç¿Œæ—¥ç”¨ï¼‰</button>
            </div>
        </section>

        <!-- Log -->
        <section class="card">
            <div class="card-header">ğŸ“‹ è¨˜éŒ²ãƒ­ã‚°</div>
            <div class="log-container">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>æ™‚åˆ»</th>
                            <th>åŒºåˆ†</th>
                            <th>æ™‚é–“</th>
                            <th>ãƒ¡ãƒ¢</th>
                        </tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">ç¨¼åƒæ™‚é–“</div>
                    <div class="kpi-value" id="kpiRun">0åˆ†</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">åœæ­¢æ™‚é–“</div>
                    <div class="kpi-value" id="kpiStop">0åˆ†</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">ç¨¼åƒç‡</div>
                    <div class="kpi-value" id="kpiRate">--%</div>
                </div>
            </div>
            <div class="controls">
                <button id="csvBtn">ğŸ“¥ CSV</button>
                <button id="clearBtn">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button id="timelineBtn">ğŸ“Š ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
                <button id="fullscreenBtn">ğŸ” æ‹¡å¤§è¡¨ç¤º</button>
                <button id="printBtn">ğŸ–¨ï¸ å°åˆ·</button>
            </div>

            <!-- Timeline Section -->
            <div class="timeline-section hidden" id="timelineSection">
                <div class="timeline-header">
                    <span class="timeline-title">ğŸ“Š ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</span>
                    <span style="font-size: 0.75rem; color: var(--text-sub);">08:15 - 17:00</span>
                </div>
                <div class="timeline-container">
                    <div class="timeline-scale" id="timelineScale"></div>
                    <div class="timeline-lane" id="timelineLane"></div>
                </div>
                <div class="timeline-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #a855f7;"></div>ç«‹ã¡ä¸Šã’
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #22c55e;"></div>ç¨¼åƒ
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f59e0b;"></div>æ¬¡Lotã¸
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ef4444;"></div>è¨­å‚™ç•°å¸¸
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #6b7280;"></div>ç«‹ã¡ä¸‹ã’
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot"
                            style="background: repeating-linear-gradient(45deg, #94a3b8, #94a3b8 2px, transparent 2px, transparent 4px);">
                        </div>ä¼‘æ†©(ç›®å®‰)
                    </div>
                </div>
            </div>
        </section>

        <!-- Breakdown Section -->
        <section class="card" id="breakdownSection">
            <div class="card-header">ğŸ“ˆ éç¨¼åƒæ™‚é–“ å†…è¨³</div>
            <div id="breakdownContent">
                <div style="color: var(--text-sub); font-size: 0.9rem;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </section>
    </main>

    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay hidden" id="fullscreenOverlay">
        <div class="fullscreen-header">
            <h2>ğŸ“Š ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆæ‹¡å¤§è¡¨ç¤ºï¼‰</h2>
            <button class="fullscreen-close" id="fullscreenClose">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div class="fullscreen-timeline">
            <div class="timeline-scale" id="fullscreenScale"></div>
            <div class="timeline-lane fullscreen-lane" id="fullscreenLane"></div>
            <div class="timeline-legend" style="margin-top: 20px;">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #a855f7;"></div>ç«‹ã¡ä¸Šã’
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #22c55e;"></div>ç¨¼åƒ
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f59e0b;"></div>æ¬¡Lotã¸
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ef4444;"></div>è¨­å‚™ç•°å¸¸
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #6b7280;"></div>ç«‹ã¡ä¸‹ã’
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="fullscreen-overlay hidden" id="helpModal" style="background: rgba(0,0,0,0.8);">
        <div class="fullscreen-header">
            <h2>â“ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <button class="fullscreen-close" id="helpClose">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div class="fullscreen-timeline" style="max-width: 800px; margin: 0 auto;">
            <h3 style="margin-bottom: 16px; color: var(--primary);">ğŸ“‹ åŸºæœ¬æ“ä½œãƒ•ãƒ­ãƒ¼</h3>

            <div style="margin-bottom: 20px; padding: 16px; background: #faf5ff; border-radius: 10px;">
                <div style="font-weight: 600; color: #a855f7; margin-bottom: 8px;">ğŸ”§ ã‚¹ãƒ†ãƒ¼ã‚¸1: ç«‹ã¡ä¸Šã’</div>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>æœã€è¨­å‚™ã®é›»æºã‚’å…¥ã‚Œã¦ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—é–‹å§‹</li>
                    <li>ã€Œç«‹ã¡ä¸Šã’ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                    <li>æº–å‚™ãŒå®Œäº†ã—ãŸã‚‰ã€Œç«‹ã¡ä¸Šã’ å®Œäº†ã€ã‚’æŠ¼ã™</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px; padding: 16px; background: #f0fdf4; border-radius: 10px;">
                <div style="font-weight: 600; color: #22c55e; margin-bottom: 8px;">â–¶ï¸ ã‚¹ãƒ†ãƒ¼ã‚¸2: é€šå¸¸ä½œæ¥­</div>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>ã€Œç¨¼åƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦è£½é€ é–‹å§‹</li>
                    <li>LotãŒçµ‚ã‚ã£ãŸã‚‰ã€Œç¨¼åƒ çµ‚äº†ã€ã‚’æŠ¼ã™</li>
                    <li>æ¬¡ã®Lotã¸åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆã¯ã€Œæ¬¡Lotã¸ã€ã‚’æŠ¼ã™</li>
                    <li>è¨­å‚™ç•°å¸¸ã‚„éƒ¨å“äº¤æ›ãŒç™ºç”Ÿã—ãŸã‚‰ãã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ â†’ ã€Œå†ç¨¼åƒã€ã§å†é–‹</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px; padding: 16px; background: #f3f4f6; border-radius: 10px;">
                <div style="font-weight: 600; color: #6b7280; margin-bottom: 8px;">â¹ï¸ ã‚¹ãƒ†ãƒ¼ã‚¸3: ç«‹ã¡ä¸‹ã’</div>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>æœ€å¾Œã®LotãŒçµ‚ã‚ã£ãŸã‚‰ã€Œç«‹ã¡ä¸‹ã’ é–‹å§‹ã€ã‚’æŠ¼ã™</li>
                    <li>è¨­å‚™ã®ç‰‡ä»˜ã‘ãŒå®Œäº†ã—ãŸã‚‰ã€Œç«‹ã¡ä¸‹ã’ å®Œäº†ã€ã‚’æŠ¼ã™</li>
                    <li>è‡ªå‹•ã§è¨˜éŒ²ãŒLocalStorageã«ä¿å­˜ã•ã‚Œã¾ã™</li>
                </ol>
            </div>

            <h3 style="margin-bottom: 12px; color: var(--primary);">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h3>
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li>ãƒ¡ãƒ¢æ¬„ã«ç•°å¸¸ã®åŸå› ãªã©ã‚’è¨˜éŒ²ã§ãã¾ã™</li>
                <li>ã€Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã§ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º</li>
                <li>ã€Œæ‹¡å¤§è¡¨ç¤ºã€ã§å¤§ç”»é¢ç¢ºèª</li>
                <li>ã€Œå°åˆ·ã€ã§ä¸Šå¸ã¸ã®å ±å‘Šè³‡æ–™ã‚’ä½œæˆ</li>
            </ul>
        </div>
    </div>

    <script>
        // State
        let state = {
            stage: 1,          // 1=startup, 2=operation, 3=shutdown, 4=complete
            subState: 'idle',  // idle, running, paused, preEvent
            eventStart: null,
            pauseType: null,
            events: []
        };

        let timerInterval = null;

        // DOM
        const dateInput = document.getElementById('dateInput');
        const productSelect = document.getElementById('productSelect');

        // Helpers
        function now() { return new Date(); }
        function formatTime(d) { return d.toTimeString().slice(0, 5); }
        function minutesBetween(s, e) { return Math.round((e - s) / 60000); }
        function todayStr() { return new Date().toISOString().slice(0, 10); }

        // Timer
        function startTimer(displayId) {
            stopTimer();
            updateTimerDisplay(displayId);
            timerInterval = setInterval(() => updateTimerDisplay(displayId), 1000);
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }

        function updateTimerDisplay(displayId) {
            if (state.eventStart) {
                const mins = minutesBetween(state.eventStart, now());
                document.getElementById(displayId).textContent = `${mins} åˆ†`;
            }
        }

        // UI State
        function hideAll() {
            ['stage1', 'stage1Running', 'stage2Idle', 'stage2Running', 'stage2Paused', 'stage2PreEvent', 'stage3', 'stageComplete'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showState(stateId) {
            hideAll();
            document.getElementById(stateId).classList.remove('hidden');
            updateStageIndicator();
        }

        function updateStageIndicator() {
            const dots = ['stage1Dot', 'stage2Dot', 'stage3Dot'];
            const labels = ['ã‚¹ãƒ†ãƒ¼ã‚¸1: ç«‹ã¡ä¸Šã’', 'ã‚¹ãƒ†ãƒ¼ã‚¸2: é€šå¸¸ä½œæ¥­', 'ã‚¹ãƒ†ãƒ¼ã‚¸3: ç«‹ã¡ä¸‹ã’'];

            dots.forEach((id, i) => {
                const dot = document.getElementById(id);
                dot.classList.remove('active', 'completed');
                if (i + 1 < state.stage) dot.classList.add('completed');
                else if (i + 1 === state.stage) dot.classList.add('active');
            });

            if (state.stage <= 3) {
                document.getElementById('stageLabel').textContent = labels[state.stage - 1];
            } else {
                document.getElementById('stageLabel').textContent = 'å®Œäº†';
            }
        }

        // Event Recording
        function addEvent(type, start, end, color) {
            const duration = minutesBetween(start, end);
            if (duration >= 0) {
                state.events.push({
                    date: dateInput.value,
                    product: productSelect.value,
                    type, start: formatTime(start), end: formatTime(end), duration, color
                });
                renderLog();
                saveState();
            }
        }

        // Stage 1: Startup
        document.getElementById('startupBtn').addEventListener('click', () => {
            state.eventStart = now();
            showState('stage1Running');
            startTimer('startupTimer');
        });

        document.getElementById('startupEndBtn').addEventListener('click', () => {
            stopTimer();
            addEvent('ç«‹ã¡ä¸Šã’', state.eventStart, now(), '#a855f7');
            state.stage = 2;
            state.subState = 'idle';
            state.eventStart = null;
            showState('stage2Idle');
        });

        // Stage 2: Idle -> Running
        document.getElementById('runStartBtn').addEventListener('click', () => {
            state.eventStart = now();
            state.subState = 'running';
            showState('stage2Running');
            startTimer('runTimer');
        });

        // Stage 2: Running -> Stop
        document.getElementById('runStopBtn').addEventListener('click', () => {
            stopTimer();
            addEvent('ç¨¼åƒ', state.eventStart, now(), '#22c55e');
            state.subState = 'idle';
            state.eventStart = null;
            showState('stage2Idle');
        });

        // Stage 2: Running -> Pause (ç•°å¸¸/éƒ¨å“äº¤æ›)
        document.getElementById('runningEvents').addEventListener('click', (e) => {
            const btn = e.target.closest('.sub-btn');
            if (!btn) return;
            stopTimer();
            addEvent('ç¨¼åƒ', state.eventStart, now(), '#22c55e');
            state.pauseType = btn.dataset.type;
            state.eventStart = now();
            state.subState = 'paused';
            document.getElementById('pausedLabel').textContent = `${state.pauseType} ä¸­`;
            showState('stage2Paused');
            startTimer('pausedTimer');
        });

        // Stage 2: Paused -> Resume
        document.getElementById('resumeBtn').addEventListener('click', () => {
            stopTimer();
            addEvent(state.pauseType, state.eventStart, now(), getColor(state.pauseType));
            state.eventStart = now();
            state.subState = 'running';
            showState('stage2Running');
            startTimer('runTimer');
        });

        // Stage 2: Pre-run events (Lotåˆ‡æ›¿, æ®µå–ã‚Šæ›¿ãˆ)
        document.getElementById('stage2Idle').addEventListener('click', (e) => {
            const btn = e.target.closest('.sub-btn');
            if (!btn) return;
            state.pauseType = btn.dataset.type;
            state.eventStart = now();
            state.subState = 'preEvent';
            document.getElementById('preEventLabel').textContent = `${state.pauseType} ä¸­`;
            showState('stage2PreEvent');
            startTimer('preEventTimer');
        });

        document.getElementById('preEventEndBtn').addEventListener('click', () => {
            stopTimer();
            addEvent(state.pauseType, state.eventStart, now(), getColor(state.pauseType));
            state.eventStart = now();
            state.subState = 'running';
            showState('stage2Running');
            startTimer('runTimer');
        });

        // Stage 3: Shutdown
        document.getElementById('shutdownBtn').addEventListener('click', () => {
            state.stage = 3;
            state.eventStart = now();
            showState('stage3');
            startTimer('shutdownTimer');
        });

        document.getElementById('shutdownEndBtn').addEventListener('click', () => {
            stopTimer();
            addEvent('ç«‹ã¡ä¸‹ã’', state.eventStart, now(), '#6b7280');
            state.stage = 4;
            state.eventStart = null;
            showState('stageComplete');
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ­ã‚°ã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰')) {
                state.stage = 1;
                state.subState = 'idle';
                state.eventStart = null;
                showState('stage1');
                saveState();
            }
        });

        function getColor(type) {
            const colors = {
                'ç«‹ã¡ä¸Šã’': '#a855f7', 'ç«‹ã¡ä¸‹ã’': '#6b7280', 'ç¨¼åƒ': '#22c55e',
                'æ¬¡Lotã¸': '#f59e0b',
                'è¨­å‚™ç•°å¸¸': '#ef4444', 'éƒ¨å“äº¤æ›': '#a855f7'
            };
            return colors[type] || '#888';
        }

        // Render Log
        function renderLog() {
            document.getElementById('logBody').innerHTML = state.events.map((ev, idx) => `
                <tr>
                    <td>${ev.start} - ${ev.end}</td>
                    <td><span class="type-badge" style="background: ${ev.color}">${ev.type}</span></td>
                    <td>${ev.duration}åˆ†</td>
                    <td><input type="text" class="memo-input" data-idx="${idx}" value="${ev.memo || ''}" placeholder="ãƒ¡ãƒ¢"></td>
                </tr>
            `).join('');

            // Memo input handlers
            document.querySelectorAll('.memo-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    state.events[idx].memo = e.target.value;
                    saveState();
                });
            });

            const runTime = state.events.filter(e => e.type === 'ç¨¼åƒ').reduce((a, b) => a + b.duration, 0);
            const stopTime = state.events.filter(e => e.type !== 'ç¨¼åƒ').reduce((a, b) => a + b.duration, 0);
            const total = runTime + stopTime;
            const rate = total > 0 ? Math.round((runTime / total) * 100) : 0;

            document.getElementById('kpiRun').textContent = `${runTime}åˆ†`;
            document.getElementById('kpiStop').textContent = `${stopTime}åˆ†`;
            document.getElementById('kpiRate').textContent = `${rate}%`;

            renderBreakdown();
        }

        // Render Breakdown
        function renderBreakdown() {
            const fixedTypes = ['ç«‹ã¡ä¸Šã’', 'ç«‹ã¡ä¸‹ã’'];
            const variableTypes = ['æ¬¡Lotã¸', 'è¨­å‚™ç•°å¸¸', 'éƒ¨å“äº¤æ›'];

            const fixed = state.events.filter(e => fixedTypes.includes(e.type));
            const variable = state.events.filter(e => variableTypes.includes(e.type));

            const fixedTotal = fixed.reduce((a, b) => a + b.duration, 0);
            const variableTotal = variable.reduce((a, b) => a + b.duration, 0);
            const nonOpTotal = fixedTotal + variableTotal;

            if (nonOpTotal === 0) {
                document.getElementById('breakdownContent').innerHTML =
                    '<div style="color: var(--text-sub); font-size: 0.9rem;">éç¨¼åƒã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const fixedPct = Math.round((fixedTotal / nonOpTotal) * 100);
            const variablePct = 100 - fixedPct;

            const fixedDetails = [...new Set(fixed.map(e => e.type))].map(type => {
                const dur = fixed.filter(e => e.type === type).reduce((a, b) => a + b.duration, 0);
                return `${type} ${dur}åˆ†`;
            }).join(', ');

            const variableDetails = [...new Set(variable.map(e => e.type))].map(type => {
                const dur = variable.filter(e => e.type === type).reduce((a, b) => a + b.duration, 0);
                return `${type} ${dur}åˆ†`;
            }).join(', ');

            document.getElementById('breakdownContent').innerHTML = `
                <div style="margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #6b7280;">ğŸ“Œ å›ºå®šï¼ˆå‰Šæ¸›å›°é›£ï¼‰: ${fixedTotal}åˆ† (${fixedPct}%)</div>
                    <div style="font-size: 0.85rem; color: var(--text-sub); margin-left: 20px;">${fixedDetails || 'ãªã—'}</div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #f59e0b;">âš¡ å¤‰å‹•ï¼ˆæ”¹å–„å¯èƒ½ï¼‰: ${variableTotal}åˆ† (${variablePct}%)</div>
                    <div style="font-size: 0.85rem; color: var(--text-sub); margin-left: 20px;">${variableDetails || 'ãªã—'}</div>
                </div>
            `;
        }

        // CSV
        document.getElementById('csvBtn').addEventListener('click', () => {
            const header = 'æ—¥ä»˜,è£½å“,åŒºåˆ†,é–‹å§‹,çµ‚äº†,æ™‚é–“(åˆ†)\n';
            const rows = state.events.map(e => `${e.date},${e.product},${e.type},${e.start},${e.end},${e.duration}`).join('\n');
            const blob = new Blob([header + rows], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `time_record_${dateInput.value}.csv`; a.click();
        });

        // Clear
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('è¨˜éŒ²ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                state.events = [];
                state.stage = 1;
                state.subState = 'idle';
                showState('stage1');
                renderLog();
                saveState();
            }
        });

        // Persistence
        function saveState() {
            localStorage.setItem('timeRecorderV2', JSON.stringify({
                stage: state.stage, subState: state.subState, events: state.events,
                date: dateInput.value, product: productSelect.value
            }));
        }

        function loadState() {
            const saved = localStorage.getItem('timeRecorderV2');
            if (saved) {
                const data = JSON.parse(saved);
                state.stage = data.stage || 1;
                state.subState = data.subState || 'idle';
                state.events = data.events || [];
                if (data.date) dateInput.value = data.date;
                if (data.product) productSelect.value = data.product;
            }
        }

        // Init
        dateInput.value = todayStr();
        loadState();
        renderLog();

        // Restore UI state
        if (state.stage === 1) showState('stage1');
        else if (state.stage === 2) showState('stage2Idle');
        else if (state.stage === 3) showState('stage3');
        else showState('stageComplete');

        // Timeline
        const WORK_START = 8 * 60 + 15;  // 08:15 in minutes
        const WORK_END = 17 * 60;        // 17:00 in minutes
        const BREAKS = [
            { start: 10 * 60, duration: 5, label: 'ä¼‘æ†©' },      // 10:00-10:05
            { start: 11 * 60 + 45, duration: 45, label: 'æ˜¼ä¼‘æ†©' }, // 11:45-12:30
            { start: 15 * 60, duration: 10, label: 'ä¼‘æ†©' }     // 15:00-15:10
        ];

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function renderTimeline() {
            const scale = document.getElementById('timelineScale');
            const lane = document.getElementById('timelineLane');
            const totalMinutes = WORK_END - WORK_START;

            // Clear
            scale.innerHTML = '';
            lane.innerHTML = '';

            // Draw time scale (every hour)
            for (let t = Math.ceil(WORK_START / 60) * 60; t <= WORK_END; t += 60) {
                const pct = ((t - WORK_START) / totalMinutes) * 100;
                const tick = document.createElement('span');
                tick.className = 'timeline-tick';
                tick.style.left = `${pct}%`;
                tick.textContent = `${Math.floor(t / 60)}:00`;
                scale.appendChild(tick);
            }

            // Draw break markers (background)
            BREAKS.forEach(brk => {
                const startPct = ((brk.start - WORK_START) / totalMinutes) * 100;
                const widthPct = (brk.duration / totalMinutes) * 100;
                if (startPct >= 0 && startPct < 100) {
                    const marker = document.createElement('div');
                    marker.className = 'timeline-break';
                    marker.style.left = `${Math.max(0, startPct)}%`;
                    marker.style.width = `${widthPct}%`;
                    const label = document.createElement('span');
                    label.className = 'timeline-break-label';
                    label.textContent = brk.label;
                    marker.appendChild(label);
                    lane.appendChild(marker);
                }
            });

            // Draw event bars
            state.events.forEach(ev => {
                const startMin = timeToMinutes(ev.start);
                const endMin = timeToMinutes(ev.end);
                const startPct = ((startMin - WORK_START) / totalMinutes) * 100;
                const widthPct = ((endMin - startMin) / totalMinutes) * 100;

                if (startPct >= 0 && widthPct > 0) {
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    bar.style.left = `${Math.max(0, startPct)}%`;
                    bar.style.width = `${Math.max(0.5, widthPct)}%`;
                    bar.style.background = ev.color;
                    bar.title = `${ev.start}-${ev.end} ${ev.type} (${ev.duration}åˆ†)`;
                    if (widthPct > 8) {
                        bar.textContent = ev.type;
                    }
                    lane.appendChild(bar);
                }
            });
        }

        // Timeline toggle button
        let timelineVisible = false;
        document.getElementById('timelineBtn').addEventListener('click', () => {
            timelineVisible = !timelineVisible;
            const section = document.getElementById('timelineSection');
            section.classList.toggle('hidden', !timelineVisible);
            if (timelineVisible) {
                renderTimeline();
            }
        });

        // Admin panel toggle
        document.getElementById('adminToggle').addEventListener('click', () => {
            const settings = document.getElementById('adminSettings');
            const badge = document.getElementById('adminBadge');
            settings.classList.toggle('hidden');
            badge.classList.toggle('visible');
        });

        // Fullscreen Timeline
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('hidden');
            renderFullscreenTimeline();
        });

        document.getElementById('fullscreenClose').addEventListener('click', () => {
            document.getElementById('fullscreenOverlay').classList.add('hidden');
        });

        function renderFullscreenTimeline() {
            const scale = document.getElementById('fullscreenScale');
            const lane = document.getElementById('fullscreenLane');
            const totalMinutes = WORK_END - WORK_START;

            scale.innerHTML = '';
            lane.innerHTML = '';

            // Draw time scale
            for (let t = Math.ceil(WORK_START / 60) * 60; t <= WORK_END; t += 60) {
                const pct = ((t - WORK_START) / totalMinutes) * 100;
                const tick = document.createElement('span');
                tick.className = 'timeline-tick';
                tick.style.left = `${pct}%`;
                tick.textContent = `${Math.floor(t / 60)}:00`;
                scale.appendChild(tick);
            }

            // Draw break markers
            BREAKS.forEach(brk => {
                const startPct = ((brk.start - WORK_START) / totalMinutes) * 100;
                const widthPct = (brk.duration / totalMinutes) * 100;
                if (startPct >= 0 && startPct < 100) {
                    const marker = document.createElement('div');
                    marker.className = 'timeline-break';
                    marker.style.left = `${Math.max(0, startPct)}%`;
                    marker.style.width = `${widthPct}%`;
                    lane.appendChild(marker);
                }
            });

            // Draw event bars
            state.events.forEach(ev => {
                const startMin = timeToMinutes(ev.start);
                const endMin = timeToMinutes(ev.end);
                const startPct = ((startMin - WORK_START) / totalMinutes) * 100;
                const widthPct = ((endMin - startMin) / totalMinutes) * 100;

                if (startPct >= 0 && widthPct > 0) {
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar fullscreen-bar';
                    bar.style.left = `${Math.max(0, startPct)}%`;
                    bar.style.width = `${Math.max(0.5, widthPct)}%`;
                    bar.style.background = ev.color;
                    bar.title = `${ev.start}-${ev.end} ${ev.type} (${ev.duration}åˆ†)`;
                    bar.textContent = `${ev.type} ${ev.duration}åˆ†`;
                    lane.appendChild(bar);
                }
            });
        }

        // Print
        document.getElementById('printBtn').addEventListener('click', () => {
            // Show timeline for print
            document.getElementById('timelineSection').classList.remove('hidden');
            renderTimeline();

            setTimeout(() => {
                window.print();
            }, 100);
        });

        // History - Save by date
        function saveHistory() {
            const date = dateInput.value;
            if (!date || state.events.length === 0) return;

            const history = JSON.parse(localStorage.getItem('timeRecorderHistory') || '{}');
            history[date] = {
                events: state.events,
                product: productSelect.value
            };
            localStorage.setItem('timeRecorderHistory', JSON.stringify(history));
        }

        // Auto-save history on shutdown complete
        const originalShutdownHandler = document.getElementById('shutdownEndBtn').onclick;
        document.getElementById('shutdownEndBtn').addEventListener('click', () => {
            saveHistory();
        });

        // Help Modal
        document.getElementById('helpBtn').addEventListener('click', () => {
            document.getElementById('helpModal').classList.remove('hidden');
        });

        document.getElementById('helpClose').addEventListener('click', () => {
            document.getElementById('helpModal').classList.add('hidden');
        });
    </script>
</body>

</html>